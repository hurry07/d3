<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link type="text/css" rel="stylesheet" href="css/theme.css"/>
    <script type="text/javascript" src="../d3.js"></script>
    <script type="text/javascript" src="api/node.js"></script>
    <script type="text/javascript" src="api/operation.js"></script>
    <script type="text/javascript" src="api/gl-matrix.js"></script>
</head>
<body>
<div class='chart'>
</div>
<div id='input' class="floating">
    <input type="text" class="fieldinput">
</div>
<!--<img src="test.png" />-->
<script type="text/javascript">
var log = function () {
    console.log(arguments);
}

//chrome.exe -allow-fi le-access-from-files
// ======================
// Field
// ======================
var Field = _extends(function (p) {
    Node.call(this, p);
}, Node, {
    enter: function () {
        var p = Table.prototype.prefer;
        var fw = p.width;
        var fh = p.field.height;
        var fp = p.field.prefix;
        var i = ListNode.prototype.getChildIndex(this);
        var d = this.data;

        var bgstyle = (i & 1) == 0 ? 'fields-light' : 'fields-dark';

        this.view = this.parentView().append('svg:g')
                .classed(bgstyle, true)
                .on('click', this.handleEdit)
                .datum(d);

        var ui = this.view;
        ui.attr("transform", 'translate(' + 0 + ',' + (fh * i) + ')');
        ui.append('svg:rect')
                .attr('width', fw)
                .attr('height', fh)
//                .on('mousedown', this.handleDown)
//                .on('mouseover', this.handleOver);

        ui.append('svg:text')
                .classed('fieldname', true)
                .attr('x', fp)
                .attr('y', fh / 2)
                .attr('dy', 6)
                .text(d.name)
                .on('click', this.handleClick)
                .datum(d);
    },
    update: function (dold, dnew) {
        var d = dnew;
        var ui = this.view;
        ui.select('text')
                .text(d.name);
    },
    exit: function () {
        this.deleteView(this.view);
    },
    handleClick: function (d) {
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        uiMgr.handle(UIManager.FIELD_CLICK, {type: UIManager.TYPE_FIELD, 'target': Node.getNode(d), 'id': 'name'});
    },
    handleDown: function (d) {
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        uiMgr.handle(UIManager.FIELD_DOWN, {type: UIManager.TYPE_FIELD, 'target': Node.getNode(d)});
    },
    handleOver: function (d) {
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        uiMgr.handle(UIManager.FIELD_OVER, {type: UIManager.TYPE_FIELD, 'target': Node.getNode(d)});
    },
    identifier: function (d) {
        return d.type + d.name;
    },

    // interact with text input.
    beginInput: function (id, text) {
        text.value = this.data.name;
        this.view.classed('edit', true);
    },
    endInput: function (id, text) {
        this.data.name = text.value;
        this.refresh();
        this.view.classed('edit', false);
    },
    getSize: function (id) {
        var p = Table.prototype.prefer;
        var fw = p.width;
        var fh = p.field.height;
        return [0, 0, fw, fh];
    },
    getNode: function () {
        return this.view.node();
    }
});

// ======================
// Link
// ======================
var Link = _extends(function (p) {
    Node.call(this, p);
}, Node);
/**
 * this.data {
 *     start(x,y),
 *     end(x,y)
 * }
 */
Link.prototype.enter = function () {
    var d = this.data;

    // root
    this.view = this.parentView().append('svg:g')
            .classed('link', true);

    // curve
    this.curve = this.view.append('svg:path')
            .attr('d', this.path(d));

    // ends
    this.start = this.view.append('svg:circle')
            .classed('start', true)
            .attr('r', 9)
            .attr('cx', d.start.x)
            .attr('cy', d.start.y);
    this.end = this.view.append('svg:circle')
            .classed('end', true)
            .attr('r', 9)
            .attr('cx', d.end.x)
            .attr('cy', d.end.y);
}
Link.prototype.update = function (d) {
}
Link.prototype.exit = function (d) {
}
Link.prototype.path = function (d) {
    var x1 = d.start.x;
    var y1 = d.start.y;
    var x2 = d.end.x;
    var y2 = d.end.y;
    var c1x = x1 + 200;
    var c1y = y1;
    var c2x = x2 - 100;
    var c2y = y2;

    return 'M' + x1 + ',' + y1//
            + 'C' + c1x + ',' + c1y //
            + ' ' + c2x + ',' + c2y //
            + ' ' + x2 + ',' + y2;//
}

// ======================
// Table
// ======================
var Table = _extends(function (p) {
    Node.call(this, p);
}, Node, {
    types: ['view', 'map', 'table'],
    prefer: {
        header: {
            height: 45,
            prefix: 8
        },
        field: {
            height: 24,
            prefix: 4
        },
        footer: {
            height: 18
        },
        width: 150
    },
    enter: function () {
        var d = this.data;
        var p = this.prefer.header;
        var w = this.prefer.width;

        // view
        this.view = this.parentView().append('svg:g')
                .attr('transform', 'translate(' + d.position.x + ',' + d.position.y + ')')
                .classed('table', true)
                .classed(d.type, true)
                .on('mousedown', this.handleDown)
                .datum(d);

        // header
        this.header = this.view
                .append('svg:g')
                .datum(d)
                .on('mousedown', this.handleDown)
                .on('mouseover', this.handleOver, true)
                .on('mouseout', this.handleOut, true);
        this.header.append('svg:rect')
                .attr('width', this.prefer.width)
                .attr('height', p.height)
                .classed('header', true);
        this.title = this.header.append('svg:text')
                .attr('x', p.prefix)
                .attr('y', p.height / 2)
                .attr('dy', 8)
                .classed('headername', true)
                .text(d.name)
                .datum(d);

        // fields
        var fieldsBg = this.view.append('svg:g')
                .attr("transform", 'translate(0,' + p.height + ')')
                .classed('fields', true)
                .datum(d)
                .on('mousedown', this.handleDown)
                .on('mouseover', this.handleOver, true)
                .on('mouseout', this.handleOut, true);

        this.fields = new Fields(this, fieldsBg);
        this.fields.bind(d.fields);

        // footer
        p = this.prefer.footer;
        this.footer = this.view.append('svg:rect')
                .attr('width', w)
                .attr('height', p.height)
                .attr('y', this.getHeight() - p.height)
                .classed('footer', true);
    },
    update: function (dold, dnew) {
        var d = dnew;

        this.title.text(d.name);

        this.fields.bind(dnew.fields);

        var p = this.footer;
        this.footer
                .attr('y', this.getHeight() - p.height)
                .classed('footer', true);
    },
    exit: function () {
        this.deleteView(this.view);
    },
    getHeight: function () {
        var d = this.data;
        var p = this.prefer;
        return d.fields.length * p.field.height + p.header.height + p.footer.height;
    },
    handleDown: function (d) {
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        var node = Node.getNode(d);
        uiMgr.handle(UIManager.TABLE_DOWN, {type: UIManager.TYPE_TABLE, 'target': node});
    },
    handleOver: function (d) {
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        var node = Node.getNode(d);
        uiMgr.handle(UIManager.TABLE_OVER, {type: UIManager.TYPE_TABLE, 'target': node});
    },
    handleOut: function (d) {
        console.log(d3.event);
        if(!UIManager.isSelfEvent(this)) {
            return;
        }
        var node = Node.getNode(d);
        uiMgr.handle(UIManager.TABLE_OUT, {type: UIManager.TYPE_TABLE, 'target': node});
    },
    isTable: function (t) {
        return this.types.indexOf(t) != -1;
    },
    hasField: function (f) {
        if (!f) {
            return false;
        }
        for (var i = 0, fs = this.data.fields, l = fs.length; i < l; i++) {
            if (fs[i] === f.data) {
                return true;
            }
        }
        return false;
    },
    // -------------------- interactive with drag manager
    startDrag: function () {
    },
    stopDrag: function () {
    },
    dragOffset: function (dx, dy) {
        var p = this.data.position;
        p.x += dx;
        p.y += dy;
        this.view.attr('transform', 'translate(' + p.x + ',' + p.y + ')')
    }
});

var Fields = Node.createContainer(Field);
var TableSchema = Node.createContainer(Table, {
    order: function () {
        var t = this.view.selectAll('g.table');
        var fs = ListNode.prototype.setChildIndex;
        var fg = ListNode.prototype.getChildIndex;
        t.sort(function (a, b) {
            var na = Node.getNode(a);
            var nb = Node.getNode(b);
            if (na.view.classed('focus')) {
                return 1;
            }
            if (nb.view.classed('focus')) {
                return -1;
            }
            na = fg(na);
            nb = fg(nb);
            return na == nb ? 0 : na > nb ? 1 : -1;
        });
        t.order();
        t.each(function (d, i) {
            fs(Node.getNode(d), i);
        });
    }
});

// ======================
// camera
// ======================
function Camera(svg) {
    this.svg = svg;
    this.width = svg.attr('width');
    this.height = svg.attr('height');
    this.x = 0;
    this.y = 0;
    this.scalef = 1;

    // touch start
    this.startx = 0;
    this.starty = 0;

    this.rect = svg.append('svg:rect')
            .attr('fill', 'url(#gridPattern)');
    this.apply();
}
Camera.prototype.getScale = function () {
    return this.scalef;
}
Camera.prototype.touchStart = function (x, y) {
    this.startx = x;
    this.starty = y;
}
Camera.prototype.touchEnd = function (x, y) {
    this.x -= (this.startx - x) / this.scalef;
    this.y -= (this.starty - y) / this.scalef;
    this.apply();
}
Camera.prototype.touchMove = function (x, y) {
    var x = this.x - (this.startx - x) / this.scalef;
    var y = this.y - (this.starty - y) / this.scalef;
    this.apply(x, y);
}
Camera.prototype.setStart = function (x, y) {
    this.x = x;
    this.y = y;
}
/**
 * 对屏幕上指定的点缩放
 *
 * @param scalef
 * @param currentx
 * @param currenty
 */
Camera.prototype.scale = function (scalef, currentx, currenty) {
    this.scalef = scalef;
    this.apply();
}
Camera.prototype.apply = function (endx, endy) {
    var portx = this.x;
    var porty = this.y;
    var w = this.width = window.innerWidth;
    var h = this.height = window.innerHeight;
    var sw = w / this.scalef;
    var sh = h / this.scalef;
    this.svg.attr('viewBox', portx + ' ' + porty + ' ' + sw + ' ' + sh)
            .attr('width', w)
            .attr('height', h);

    this.rect.attr('x', portx)
            .attr('y', porty)
            .attr('width', sw)
            .attr('height', sh);
}
Camera.prototype.transform = function (g, size) {
    var svgM = g.getTransformToElement(global.root);

    var matrix = mat2d.create();

    // apply child transform
    mat2d.multiply(matrix, matrix, mat2d.clone([svgM.a, svgM.b, svgM.c, svgM.d, svgM.e, svgM.f]));
    // apply camera transform
    mat2d.translate(matrix, matrix, vec2.clone([-this.x, -this.y]));
    mat2d.scale(matrix, matrix, vec2.clone([this.scalef, this.scalef]));

    // convert point on child to world
    var world = vec2.clone(size);
    vec2.transformMat2d(world, world, matrix);
    var x = world[0];
    var y = world[1];

    vec2.set(world, size[0] + size[2], size[1] + size[3]);
    vec2.transformMat2d(world, world, matrix);

    return [x, y, world[0] - x, world[1] - y];
}
// ======================
// UI Manager
// ======================
function UIManager() {
    var input = document.getElementById('input');
    this.input = new TextInput(input);

    this.drag = new DragControl();
    this.link = new LinkControl();

    // sessions that will start by mouse event
    this.mouseActions = new ActionGroup(this.drag, this.link);

    // ui drawing layers
    this.layers = {
        assistant: Node.wrap(svg.append('svg:g').classed('pAssistant', true)),
        dialog: Node.wrap(svg.append('svg:g').classed('pDialog', true))
    };

    var link = new Link(this.layers.assistant);
    link.bind({start: {x: 100, y: 100}, end: {x: 500, y: 250}});
}

// ui element types
UIManager.TYPE_TABLE = 'TABLE';
UIManager.TYPE_FIELD = 'FIELD';
UIManager.TYPE_LINK = 'LINK';
UIManager.TYPE_DIALOG = 'DIALOG';

// table & fields mouse event
UIManager.FIELD_OVER = 'fieldOver';
UIManager.FIELD_DOWN = 'fieldDown';
UIManager.FIELD_CLICK = 'fieldClick';
UIManager.TABLE_DOWN = 'tableDown';
UIManager.TABLE_OVER = 'tableOver';
UIManager.TABLE_OUT = 'tableOut';

// global mouse event
UIManager.SVG_DOWN_BEGIN = 'svgDownB';
UIManager.SVG_DOWN_END = 'svgDownE';
UIManager.SVG_UP_BEGIN = 'svgUpB';
UIManager.SVG_UP_END = 'svgUpE';
UIManager.SVG_MOVE = 'svgMove';

// link
UIManager.LINK_START_FIELD = 'linkStartField';
UIManager.LINK_START_TABLE = 'linkStartTable';
UIManager.LINK_END_FIELD = 'linkEndField';
UIManager.LINK_END_TABLE = 'linkEndTable';

UIManager.prototype.isSelfEvent = function (element) {
    var target = (d3.event.target || d3.event.srcElement);
    return  element === (d3.event.target || d3.event.srcElement);
}
UIManager.isSelfEvent = UIManager.prototype.isSelfEvent;
UIManager.prototype.ctrlKey = function () {
    return d3.event.metaKey || d3.event.ctrlKey;
}
UIManager.prototype.loseFocus = function () {
    d3.selectAll('.focus')
            .classed('focus', false);
}
UIManager.prototype.onFocus = function (param) {
//    this.input.close();
//    var d = param.target.data;
//    if (Table.prototype.isTable(d.type) != -1) {
//        tables.order();
//    }
}
/**
 * handle event on svg root element
 * @param id
 */
UIManager.prototype.handleGlobal = function (id) {
    switch (id) {
        case UIManager.SVG_DOWN_BEGIN:
            log('UIManager.SVG_DOWN_BEGIN');
            this.mouseActions.prepare();
            break;
        case UIManager.SVG_DOWN_END:
            log('UIManager.SVG_DOWN_END');
            this.mouseActions.start();
            break;
        case UIManager.SVG_MOVE:
            //log('UIManager.SVG_MOVE');
            this.mouseActions.handleEvent();
            break;
        case UIManager.SVG_UP_BEGIN:
            log('UIManager.SVG_UP_BEGIN');
            break;
        case UIManager.SVG_UP_END:
            log('UIManager.SVG_UP_END');
            this.mouseActions.stop();
            break;
    }
}
UIManager.prototype.handle = function (id, param) {
    switch (id) {
//        // {'target': controller, 'id': 'fieldid'}
//        case UIManager.INPUT:
//            this.input.handle(param);
//            break;
//        case UIManager.CLOSE_INPUT:
//            this.input.close();
//            break;

        // param: {target: node, type:'field'}
        case UIManager.FIELD_DOWN:
            log('UIManager.FIELD_DOWN', param);
            this.link.setStartField(param.target);
            break;
        case UIManager.FIELD_OVER:
            log('UIManager.FIELD_OVER', param);
            this.link.setEndField(param.target);
            break;
        case UIManager.FIELD_CLICK:
            log('UIManager.FIELD_CLICK', param);
            // TODO input
            break;

        // param: {target: node, type:'table'}
        case UIManager.TABLE_DOWN:
            log('UIManager.TABLE_DOWN', param);
            this.drag.bindTarget(param.target);
            this.link.setStartTable(param.target);
            this.onFocus(param);
            break;
        case UIManager.TABLE_OVER:
            log('UIManager.TABLE_OVER', param);
            //this.link.setEndTable(param.target);
            break;
        case UIManager.TABLE_OUT:
            log('UIManager.TABLE_OUT', param);
            //this.link.setEndTable(param.target);
            break;

//        // {'target': controller}
//        case UIManager.BG_DRAG:
//            this.drag.handleBg(param);
//            break;
//        case UIManager.ON_FOCUS:
//            this.onFocus(param);
//            break;
//        case UIManager.LOSE_FOCUS:
//            this.loseFocus();
//            break;

        // ------------------ link
        case UIManager.LINK_START_FIELD:
        case UIManager.LINK_START_TABLE:
        case UIManager.LINK_END_FIELD:
        case UIManager.LINK_END_TABLE:
            break;
    }
}
UIManager.prototype.globalKey = function () {
    console.log(d3.event);
}
function TextInput(div) {
    this.div = div;
    this.input = div.getElementsByTagName('input')[0];
    var current = this;
    var listener = function () {
        current.submit();
    }
    this.input.onchange = listener;
    this.input.onblur = listener;
    this.input.ondblclick = listener;
    this.input.onselect = listener;
}
TextInput.prototype.submit = function () {
    var n = this.node;
    if (n) {
        n.endInput(this.id, this.input);
    }
    d3.select(this.div).style('visibility', 'hidden');
}
TextInput.prototype.close = function () {
    this.submit();
}
TextInput.prototype.handle = function (param) {
    this.submit();

    var id = param.id;
    var target = param.target;

    this.node = target;
    this.id = id;

    var size = camera.transform(target.getNode(id), target.getSize(id));

    var div = d3.select(this.div);
    div.style('left', size[0] + 'px');
    div.style('top', size[1] + 'px');
    div.style('width', size[2] + 'px');
    div.style('height', size[3] + 'px');

    this.node.beginInput(this.id, this.input);
    d3.select(this.input)
            .style('font-size', Math.round(17 * camera.getScale()) + 'px')
            .style('text-indent', Math.round(4 * camera.getScale()) + 'px');
    div.style('visibility', 'visible');
}

// ==========================
// DragControl
// ==========================
function DragControl() {
    this.downx = 0;
    this.downy = 0;
}
_extends(DragControl, Action);
DragControl.prototype.prepare = function () {
    this.active = false;
    this.downx = d3.event.x;
    this.downy = d3.event.y;
    this.node = null;
}
DragControl.prototype.start = function (param) {
    // check if drag target exist
    if (!UIManager.prototype.ctrlKey() || !this.node) {
        this.stop();
    }
    this.active = true;
}
DragControl.prototype.handleEvent = function (param) {
    switch (d3.event.type) {
        case 'mousemove':
            // if user release the ctrl key, stop dragging
            if (!UIManager.prototype.ctrlKey()) {
                this.stop();
                break;
            }

            var n = this.node;
            if (n) {
                var cx, cy;
                this.downx += (cx = d3.event.x - this.downx);
                this.downy += (cy = d3.event.y - this.downy);
                n.dragOffset(cx, cy);
            } else {
                // TODO drag camera
            }
            break;
    }
}
DragControl.prototype.stop = function () {
    if (this.active) {
        uiMgr.handle(UIManager.LOSE_FOCUS);
    }
    this.active = false;
    this.node = null;
}
DragControl.prototype.bindTarget = function (target) {
    this.node = target;
//    uiMgr.handle(UIManager.ON_FOCUS, {target: param.target}); TODO
}

// ==========================
// LinkControl
// ==========================
function LinkControl() {
    this.prepare();
}
_extends(LinkControl, Action);

LinkControl.FIELD = 'field';
LinkControl.MUL_FIELD = 'mulField';

LinkControl.prototype.setStartTable = function (table) {
    var t = this.data.start;
    t.table = table;
}
LinkControl.prototype.setStartField = function (field) {
    var t = this.data.start;
    t.field = field;
}
LinkControl.prototype.setEndTable = function (table) {
    var t = this.data.end;
    t.table = table;
}
LinkControl.prototype.setEndField = function (field) {
    var t = this.data.end;
    t.field = field;
}
LinkControl.prototype.setLinkType = function (t) {
    this.type = t;
}
LinkControl.prototype.updateCurve = function (x, y) {
    var d = this.data;
    if (!d.end.table) {
        //d.start.table.drawLink(x, y);
    }
}
LinkControl.prototype.prepare = function () {
    this.data = {start: {}, end: {}};
    this.type = LinkControl.FIELD;
    this.active = false;
}
LinkControl.prototype.validate = function (link) {
    if (link.table) {
        if (!link.table.hasField(link.field)) {
            delete link.field;
        }
    }
}
LinkControl.prototype.start = function () {
    var d = this.data
    if (UIManager.prototype.ctrlKey() || !d.start.table) {
        this.stop();
        return;
    }
    this.validate(d.start);
    this.active = true;
}
LinkControl.prototype.handleEvent = function () {
    switch (d3.event.type) {
        case 'mousemove':
            // if user release the ctrl key, stop dragging
            if (UIManager.prototype.ctrlKey()) {
                this.stop();
                break;
            }
            this.updateCurve(d3.event.x, d3.event.y);
            break;
    }
}
LinkControl.prototype.stop = function () {
    this.prepare();
}

// ======================
// global
// ======================
var svg = d3.selectAll('.chart')
        .append("svg")
        .attr('width', window.innerWidth)
        .attr('height', window.innerHeight)
        .attr('id', 'svg');

svg.append('svg:defs')
        .append('svg:pattern')
        .attr('id', 'gridPattern')
        .attr('x', 0)
        .attr('y', 0)
        .attr('width', 15)
        .attr('height', 15)
        .attr('patternUnits', 'userSpaceOnUse')
        .append('svg:path')
        .attr('d', 'M 15 0 L 0 0 0 15')
        .attr('fill', 'none')
        .attr('stroke', '#6DA0A1')
        .attr('stroke-width', '0.25');

var global = {
    root: document.getElementById('svg')
}

var camera = new Camera(svg);
var tables = new TableSchema(null, svg.append('svg:g').classed('entity', true));
var uiMgr = new UIManager();

// global listeners register
window.addEventListener('resize', function () {
    var width = window.innerWidth;
    var height = window.innerHeight;
//    camera.setStart(-100, 50);
//    camera.scale(1.2, 0, 0);
    camera.apply();
});

function listenSvg(id) {
    return function () {
        uiMgr.handleGlobal(id);
    }
}
svg.on('mousedown.start', listenSvg(UIManager.SVG_DOWN_BEGIN), true)
        .on('mousedown.end', listenSvg(UIManager.SVG_DOWN_END))
        .on('mousemove', listenSvg(UIManager.SVG_MOVE), true)
        .on('mouseup.start', listenSvg(UIManager.SVG_UP_BEGIN), true)
        .on('mouseup.end', listenSvg(UIManager.SVG_UP_END))
//        .on('keydown', uiMgr.globalKey);

document.onkeydown = function () {
    console.log('document.onkeydown');
};

// ======================
// binding data
// ======================
d3.json("api/data.json", function (data) {
    tables.bind(data.entities);
});
</script>
</body>
</html>